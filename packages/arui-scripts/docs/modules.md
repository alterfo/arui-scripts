# Модули приложений

## Мотивация
Модули приложений предназначены для решения простой проблемы - переиспользование фронтового кода между приложениями.

В целом, для того чтобы переиспользовать код у нас есть много разных способов, например:
- копировать код из одного приложения в другое. Быстро, но неудобно и неэффективно.
- выносить код в отдельный пакет и подключать его через npm. Понятный и достаточно удобный вариант,
но ограничивает нас в скорости изменений. Если мы хотим заменить обновить код в пакете, процесс
раскатки этого обновления на все приложения может занять много времени.
- Сделать так, чтобы мы могли подключать код из других приложений в свое. При этом мы получаем
возможность быстро изменить общий код только в одном месте, а все приложения автоматически получат
обновления. Именно так и работают модули приложений.

## Типы модулей
Несмотря на кажущуюся простоту концепции, можно представить разные сценарии использования модулей. В ряде случаев
мы хотим просто предоставить доступ к коду из другого приложения, в других - мы хотим иметь возможность
настраивать поведение модуля в зависимости от приложения, в котором он используется. Или мы хотим сделать так, чтобы
наш модуль мог сразу же получить какие-то данные с сервера, потому что его поведение зависит от этих данных.

Из-за того, что эти сценарии различаются, мы выделили два типа модулей:

- Клиентские модули. Это модули, которые имеют только клиентскую часть.
- Модули с серверной частью. Это модули, которые имеют как клиентскую, так и серверную часть. Серверная часть может
реализовывать какую-то логику, которая не может быть реализована на клиенте, например отдавать разные модули в зависимости
от пользователя, получать предподготовленные данные с сервера и т.д.

## Режимы подключения модулей

Кроме того, модули делятся еще и по способу их подключения:
- `mf` модули. Это модули, которые подключаются с помощью [webpack module federation](https://webpack.js.org/concepts/module-federation/).
- `legacy` модули. Такие модули подключаются просто через добавление нужных скриптов на страницу приложения.

У обоих методов есть свои преимущества и недостатки. Модули типа `mf` позволяют легко шарить библиотеки между приложением,
которое подключает модуль, и самим модулем. Это позволяет сократить объем данных, которые нужно передавать на клиент,
в то же время позволяя не особо задумываться о версиях библиотек. ModuleFederation прекрасно сам разберется с доступностью
нужных версий библиотек, и подключит их только когда это реально необходимо (например хост-приложение не имеет нужной библиотеки,
или использует несовместимую версию).

В то же время `mf` модули сильно ограничены в том, как именно нужно работать со стилями. Все стили модуля будут
применены к хост-приложению, и нам необходимо быть готовыми к тому, что стили модуля могут переопределить стили
хоста. Эта проблема может быть решена либо с помощью shadow-dom, либо с помощью css-modules. Если вы можете использовать
эти технологии - `mf` модули для вас.

`legacy` модули же имеют возможность изолировать стили модуля от стилей хоста, но при этом в них нет встроенной
возможности шарить библиотеки между модулем и хостом. Это значит, что если мы хотим использовать одну и ту же библиотеку
в нескольких модулях, то она будет подключена в каждый модуль отдельно.
Эту проблему так же можно решать например помечая часть библиотек как `external`, и предоставление их хостом через
`expose-loader`. Но такой подход требует четкого соответствия версий библиотек в модуле и хосте, и не позволяет
легко менять версии библиотек в модуле.

## Как создать модуль
Для того чтобы ваше приложение начало предоставлять модули, вам необходимо добавить настройки в `arui-scripts.config.ts`:

```ts
import { PackageSettings } from 'arui-scripts';

const aruiScriptsConfig: PackageSettings = {
    // legacy модули
    applicationModules: [
        {
            name: 'ClientWidgetLegacy',
            entry: './src/widgets/client-widget-legacy/index',
        },
        {
            name: 'ServerWidgetLegacy',
            entry: './src/widgets/server-widget-legacy/index',
        }
    ],
    // mf модули
    mfModules: {
        shared: {
            'react': '^17.0.0',
            'react-dom': '^17.0.0',
        },
        exposes: {
            'ClientWidgetMF': './src/widgets/client-widget-mf/index',
            'ServerWidgetMF': './src/widgets/server-widget-mf/index',
        }
    }
}

export default aruiScriptsConfig;
```
